#!/usr/bin/env python
# A script and module for manipulating Alien package managers.
# Copyright 2009 Michael Homer. Released under the GNU GPL 2 or later.

import os
import subprocess
import CheckDependencies
from PythonUtils import *

alien_manager_states = {}
alien_package_states = {}


def dependencymet(rule):
    alientype, alienpkg  = split(rule['program'])
    lowerbound = ''
    upperbound = ''
    for comp, val in rule['versions']:
        if comp == '>=':
            lowerbound = val
        elif comp == '<':
            upperbound = val
    if 0 == subprocess.call(['Alien-' + alientype, '--met', alienpkg,
                             lowerbound, upperbound]):
        return True
    return False

    
def getinstallversion(rule):
    alientype, alienpkg = rule['program'].split(':', 1)
    p = subprocess.Popen(['Alien-' + alientype, '--getinstallversion',
                          alienpkg], stdout=subprocess.PIPE)
    return p.stdout.read().strip()


def split(program):
    return program.split(':', 1)


def havealienmanager(alientype):
    if alientype in alien_manager_states:
        return alien_manager_states[alientype]
    res = 0 == subprocess.call(['Alien-' + alientype, '--have-manager'])
    alien_manager_states[alientype] = res
    return res


def getmanagerrule(alientype):
    p = subprocess.Popen(['Alien-' + alientype, '--get-manager-rule'],
                         stdout=subprocess.PIPE)
    rulestr = p.stdout.read().strip()
    rule = CheckDependencies.interpret_dependency_line(rulestr)
    return rule

if __name__ == '__main__':
    if len(sys.argv) < 3:
        print "Usage: Alien --<mode> AlienType:alienpkg [...]"
        exit(1)
    mode = sys.argv[1]
    prog = sys.argv[2]
    alientype, alienpkg = split(prog)
    args = ['Alien-' + alientype, mode, alienpkg] + sys.argv[3:]
    exit(subprocess.call(args))
    
